<!DOCTYPE html>
<html>
  <head>
    <title>Ανέβασμα εικόνων στο Amazon S3</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/index.css">
    
    <script src="../js/jquery.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
  </head>

  <body>

     <nav class="navbar navbar-expand-md fixed-top" id="mainNav">

        <div class="container">
            <a class="navbar-brand" href="../index.html">SpringTutorial</a>

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false">
                <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav ml-5">
                <li class="nav-item dropdown">
                          <a class="nav-link dropdown-toggle" href="#" id="navbarSpring" data-toggle="dropdown">Spring</a>
                          <div class="dropdown-menu">
                              <a class="dropdown-item" href="spring.html">What is Spring</a>
                              <a class="dropdown-item" href="spring-container.html">Spring IoC Container</a>
                              <a class="dropdown-item" href="spring-beans.html">Spring Beans</a>
                              <a class="dropdown-item" href="dependency-injection.html">Dependency Injection</a>
                              <a class="dropdown-item" href="annotations.html">Annotations</a>
                              <a class="dropdown-item" href="spring-boot.html">Spring Boot</a>
                              <a class="dropdown-item" href="spring-mvc.html">Spring Mvc</a>
                              <a class="dropdown-item" href="spring-security.html">Spring Security</a>
                              <a class="dropdown-item" href="rest-api.html">Rest API</a>
                              <a class="dropdown-item" href="application-properties.html">Application Properties</a>
                            </div>
                      </li>
                      <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarJpa" data-toggle="dropdown">JPA</a>
                            <div class="dropdown-menu">
                              <a class="dropdown-item" href="jpa.html">JPA</a>
                              <a class="dropdown-item" href="spring-data-jpa.html">Spring Data Jpa</a>
                            </div>
                      </li>
                      <li class="nav-item dropdown">
                          <a class="nav-link dropdown-toggle" href="#" id="navbarSetup" data-toggle="dropdown">Setup εφαρμογης</a>
                          <div class="dropdown-menu">
                              <a class="dropdown-item" href="app-architecture.html">Αρχιτεκτονική εφαρμογής</a>
                              <a class="dropdown-item" href="spring-tool-suite.html">Spring Tool Suite</a>
                              <a class="dropdown-item" href="heroku.html">Heroku</a>
                              <a class="dropdown-item" href="postgresql.html">Postgres</a>
                              <a class="dropdown-item" href="amazon-s3.html">Amazon S3</a>
                              <a class="dropdown-item" href="angular.html">Angular</a>
                              <a class="dropdown-item" href="create-frontend.html">Δημιουργία Frontend</a> 
                              <a class="dropdown-item" href="visual-studio-code.html">Visual Studio Code</a>
                            </div>
                      </li>
                      <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarCreateApp" data-toggle="dropdown">Κώδικας εφαρμογης</a>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" href="jpa-configuration.html">Ρύθμιση βάσης δεδομένων και JPA</a>
                            <a class="dropdown-item" href="amazons3-configuration.html">Ρύθμιση Amazon S3</a>
                            <a class="dropdown-item" href="upload-images.html">Ανέβασμα εικόνων στο Amazon S3</a>
                            <a class="dropdown-item" href="create-tables-for-products.html">Δημιουργία πινάκων products, categories, brands, product_images, inventory</a>
                            <a class="dropdown-item" href="create-components-products.html">Δημιουργία repositories, services για τους πίνακες brands, categories...</a>
                            <a class="dropdown-item" href="insert-products.html">Δημιουργία controller,repository, service για την εισαγωγή προϊόντων</a>
                            <a class="dropdown-item" href="create-tables-deals.html">Δημιουργία πινάκων deals, deal_images</a>
                            <a class="dropdown-item" href="create-components-deals.html">Δημιουργία controller,repository, service για την ανάκτηση προσφορών</a>
                            <a class="dropdown-item" href="angular-routes.html">Angular - Routes</a>
                            <a class="dropdown-item" href="create-common-components.html">Angular - Components my-footer, shop-services, navigation-bar και product</a>
                            <a class="dropdown-item" href="create-index-page.html">Angular - index-page</a>
                            <a class="dropdown-item" href="create-component-product-page.html">Angular - product-page</a>
                        </div>
                      </li>
            </ul>
        </div>
      </div>
   
    </nav>

    <div class="container">

        <h1 class="text-center">Ανέβασμα εικόνων στο Amazon S3</h1>

        <section class="intro">

            <p>Στην εφαρμογή κάθε προιόν θα έχει την ίδια εικόνα σε τρία μεγέθη:</p>

            <ul>
                <li>μεγάλο : (θα χρησιμοποιηθεί στο component product-page)</li>
                <li>μικρό : (θα χρησιμοποιηθεί στο component index)</li>
                <li>πολύ μικρό : (θα χρησιμοποιηθεί στο component cart)</li>
            </ul>

            <p>Υπάρχουν έξι κατηγορίες προιόντων :</p>

            <ol>
                <li>ιχθυέλαια (fish-oils)</li>
                <li>αρώματα (fragrances)</li>
                <li>μέταλλα (minerals)</li>
                <li>σαμπουάν (shampoos)</li>
                <li>υπερτροφές (superfoods)</li>
                <li>βιταμίνες (vitamins)</li>
            </ol>

            <p>Αρχικά, θα δημιουργήσουμε ένα φάκελο products. Μέσα στο φάκελο products, θα δημιουργήσουμε τρεις φακέλους large, small και very-small.
                Σε κάθε έναν από αυτούς, θα δημιουργήσουμε έξι φάκελους, fish-oils, fragrances, minerals, shampoos, superfoods και vitamins.
                Για να δημιουργήσουμε έναν φάκελο πατάμε Create Folder, πληκτρολογούμε το όνομα και πατάμε Save.
                <img class="img-fluid mx-auto my-5 w-100" src="../img/amazons3-files.png" alt="Amazon Files"> 
            </p>

            <p>Το βασικό URL του bucket μας είναι το https://s3.eu-central-1.amazonaws.com/springeshop-bucket/. </p>

            <p>Η μικρή εικόνα του προιόντος apivita-shampoo-dry-dandruff-250ml, το οποίο ανήκει στην κατηγορία σαμπούαν, βρίσκεται στο URL
                <a href="https://s3.eu-central-1.amazonaws.com/springeshop-bucket/products/small/shampoos/apivita-shampoo-dry-dandruff-250ml-small.jpg">https://s3.eu-central-1.amazonaws.com/springeshop-bucket/products/small/shampoos/apivita-shampoo-dry-dandruff-250ml-small.jpg</a> .
            </p>

            <p>Αντίστοιχα, η μεγάλη εικόνα του προιόντος korres-fragrance-apple-blossom-100ml, το οποίο ανήκει στην κατηγορία των αρωμάτων, βρίσκεται στο URL
                <a href="https://s3.eu-central-1.amazonaws.com/springeshop-bucket/products/large/fragrances/korres-fragrance-apple-blossom-100ml-large.jpg">https://s3.eu-central-1.amazonaws.com/springeshop-bucket/products/large/fragrances/korres-fragrance-apple-blossom-100ml-large.jpg</a> .
            </p>

        </section>

        <section class="upload-code">

            <h5>Κώδικας Spring για upload φωτογραφιών</h5>

            <p>Αρχικά, θα δημιουργήσουμε ένα package springeshop.util, το οποίο θα έχει βοηθητικές κλάσεις. Μέσα σε αυτό θα δημιουργήσουμε
                το enum ImageType.
            </p>

            <pre>
                <code>
                    &emsp;&emsp;&emsp;&emsp;<span class="keyword">package</span> springeshop.util;

                    &emsp;&emsp;&emsp;&emsp;<span class="keyword">public enum</span> ImageType {
                    &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;SMALL, LARGE, VERY_SMALL
                    &emsp;&emsp;&emsp;&emsp;}
                </code>
            </pre>

            <p>Στο ίδιο πακέτο θα δημιουργήσουμε μια κλάση Constants , η οποία θα περιέχει σταθερές</p>

            <pre>
                <code>
                        &emsp;&emsp;&emsp;&emsp;<span class="keyword">package</span> springeshop.util;

                        &emsp;&emsp;&emsp;&emsp;<span class="keyword">public final class</span> Constants {

                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span class="keyword">private static final String </span> AMAZON_S3_URL = <span class="string">"https://s3.eu-central-1.amazonaws.com/springeshop-bucket/"</span>;
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span class="keyword">private static final String </span> SMALL_PRODUCTS_PATH = <span class="string">"products/small/"</span>;
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span class="keyword">private static final String </span> LARGE_PRODUCTS_PATH = <span class="string">"products/large/"</span>;
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span class="keyword">private static final String </span> VERY_SMALL_PRODUCTS_PATH = <span class="string">"products/very-small/"</span>;

                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span class="keyword">private</span> Constants(){}

                        }
                </code>
            </pre>

            <p>Θα δημιουργήσουμε μια διεπαφή AmazonS3ClientService, η οποία περιέχει μια μέθοδο για το upload φωτογραφιών</p>

            <pre>
                <code>
                    &emsp;&emsp;&emsp;&emsp;<span class="keyword">package</span> springeshop.service;

                    &emsp;&emsp;&emsp;&emsp;<span class="keyword">public interface</span> AmazonS3ClientService {
                    &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;CompletableFuture&#60;Boolean&#62; uploadImage(MultipartFile image, String category, ImageType imageType);
                    &emsp;&emsp;&emsp;&emsp;}
                </code>
            </pre>

            <p>Η κλάση AmazonS3ClientServiceImpl θα υλοποιεί την AmazonS3ClientService. Η μέθοδος uploadImage θα κάνει το upload της εικόνας. Πρώτα μετατρέπει
                την εικόνα σε αρχείο File, κάνει upload την εικόνα στο κατάλληλο path και διαγράφει το αρχείο μετά. Επιστρέφει true, αν το upload ήταν επιτυχές.
            </p>

            <pre>
                <code>

                        &emsp;&emsp;&emsp;&emsp;<span class="keyword">package</span> springeshop.service;
                    
                        &emsp;&emsp;&emsp;&emsp;<span class="annotation">@Component</span>
                        &emsp;&emsp;&emsp;&emsp;<span class="keyword">public class </span> AmazonS3ClientServiceImpl implements AmazonS3ClientService{

                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span class="keyword">private String </span> awsS3AudioBucket
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span class="keyword">private AmazonS3 </span> AmazonS3 amazonS3;

                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span class="annotation">@Autowired</span>
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span class="keyword">public</span> AmazonS3ClientServiceImpl(Region awsRegion, AWSCredentialsProvider awsCredentialsProvider, String awsS3AudioBucket){
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;this.amazonS3 = AmazonS3ClientBuilder.standard()
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.withCredentials(awsCredentialsProvider)
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.withRegion(awsRegion.getName()).build();
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;this.awsS3AudioBucket = awsS3AudioBucket;
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}

                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span class="annotation">@Async</span>
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span class="keyword">public</span> CompletableFuture&#60;Boolean&#62; uploadImage(MultipartFile image, String category, ImageType imageType){

                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;boolean isImageUploadSuccess = true;

                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;try{
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;File imageFile = convertImageToFile(image);
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;uploadImageToS3Bucket(image.getOriginalFilename(), imageFile, category, imageType);
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;imageFile.delete();
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}catch (IOException | AmazonServiceException ex) {
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;logger.error("error [" + ex.getMessage() + "] occurred while uploading [" + image.getOriginalFilename() + "] ");
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;isImageUploadSuccess = false;
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}

                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span class="keyword">return</span> CompletableFuture.completedFuture(isImageUploadSuccess);

                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}

                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span class="keyword">private</span> File convertImageToFile(MultipartFile image) throws IOException{

                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;File convertedFile = new File(image.getOriginalFilename());
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;FileOutputStream fileOutputStream = new FileOutputStream(convertedFile);
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;fileOutputStream.write(image.getBytes());
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;fileOutputStream.close();
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span class="keyword">return</span> convertedFile;
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}


                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span class="keyword">private void</span> uploadImageToS3Bucket(String imageName, File imageFile, String category, ImageType imageType){

                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;if(imageType == ImageType.SMALL){
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;amazonS3.putObject(new PutObjectRequest(awsS3AudioBucket, Constants.SMALL_PRODUCTS_PATH + category + "/" + imageName, imageFile)
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.withCannedAcl(CannedAccessControlList.PublicRead));
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}else if(imageType == ImageType.LARGE){
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;amazonS3.putObject(new PutObjectRequest(awsS3AudioBucket, Constants.LARGE_PRODUCTS_PATH + category + "/" + imageName, imageFile)
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.withCannedAcl(CannedAccessControlList.PublicRead));
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}else if(imageType == ImageType.VERY_SMALL){
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;amazonS3.putObject(new PutObjectRequest(awsS3AudioBucket, Constants.VERY_SMALL_PRODUCTS_PATH + category + "/" + imageName, imageFile)
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.withCannedAcl(CannedAccessControlList.PublicRead));
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}

                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;}
                        
                        &emsp;&emsp;&emsp;&emsp;}
                </code>
            </pre>
        </section>

    </div>

  </body>
</html>
