<!DOCTYPE html>
<html>
  <head>
    <title>Spring Security</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/index.css">
    
    <script src="../js/jquery.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
  </head>

  <body>

    <nav class="navbar navbar-expand-md fixed-top" id="mainNav">

        <div class="container">
            <a class="navbar-brand" href="../index.html">SpringTutorial</a>

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false">
                <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav ml-5">
                <li class="nav-item dropdown">
                          <a class="nav-link dropdown-toggle" href="#" id="navbarSpring" data-toggle="dropdown">Spring</a>
                          <div class="dropdown-menu">
                              <a class="dropdown-item" href="spring.html">What is Spring</a>
                              <a class="dropdown-item" href="spring-container.html">Spring IoC Container</a>
                              <a class="dropdown-item" href="spring-beans.html">Spring Beans</a>
                              <a class="dropdown-item" href="dependency-injection.html">Dependency Injection</a>
                              <a class="dropdown-item" href="annotations.html">Annotations</a>
                              <a class="dropdown-item" href="spring-boot.html">Spring Boot</a>
                              <a class="dropdown-item" href="spring-mvc.html">Spring Mvc</a>
                              <a class="dropdown-item" href="spring-security.html">Spring Security</a>
                              <a class="dropdown-item" href="rest-api.html">Rest API</a>
                              <a class="dropdown-item" href="application-properties.html">Application Properties</a>
                            </div>
                      </li>
                      <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarJpa" data-toggle="dropdown">JPA</a>
                            <div class="dropdown-menu">
                              <a class="dropdown-item" href="jpa.html">JPA</a>
                              <a class="dropdown-item" href="spring-data-jpa.html">Spring Data Jpa</a>
                            </div>
                      </li>
                      <li class="nav-item dropdown">
                          <a class="nav-link dropdown-toggle" href="#" id="navbarSetup" data-toggle="dropdown">Setup εφαρμογης</a>
                          <div class="dropdown-menu">
                              <a class="dropdown-item" href="spring-tool-suite.html">Spring Tool Suite</a>
                              <a class="dropdown-item" href="heroku.html">Heroku</a>
                              <a class="dropdown-item" href="postgresql.html">Postgres</a>
                              <a class="dropdown-item" href="amazon-s3.html">Amazon S3</a>
                              <a class="dropdown-item" href="jpa-configuration.html">Ρύθμιση βάσης δεδομένων και JPA</a>
                            </div>
                      </li>
                      <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarCreateApp" data-toggle="dropdown">Δημιουργία εφαρμογης</a>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" href="app-architecture.html">Αρχιτεκτονική εφαρμογής</a>
                            <a class="dropdown-item" href="angular.html">Angular</a>
                            <a class="dropdown-item" href="create-frontend.html">Δημιουργία Frontend</a>
                          </div>
                      </li>
            </ul>
        </div>
      </div>
   
    </nav>

    <div class="container">

        <h1 class="text-center">Spring Security</h1>

        <section class="intro">
            <p>Το Spring Security είναι ένα <span class="bold">Java / Java EE framework</span>, το οποίο παρέχει τη δυνατότητα <span class="bold">αυθεντικοποίησης</span> (authentication), 
                <span class="bold">εξουσιοδότησης</span> (authorization) και άλλες λειτουργίες ασφάλειας για enterprise εφαρμογές. Το project ξεκίνησε το 2003 ως Acegi Security
               και ύστερα ενσωματώθηκε στο Spring portfolio , ως επίσημο Spring sub-project.</p>

            <p>Για να ενεργοποιήσουμε το Spring Security, μπορούμε να χρησιμοποιήσουμε Java Configuration. Το configuration δημιουργεί ένα <span class="bold">Servlet Filter</span>, γνωστό
                ως <span class="code">springSecurityFilterChain</span>, το οποίο είναι <span class="bold">υπεύθυνο για την προστασία της εφαρμογής</span> (προστασία των URLs, validation του ονόματος χρήστη
                και του κωδικού, κ.α.). Το πιο απλό παράδειγμα configuration δίνεται παρακάτω.
            </p>

            <pre>
                <code>
                        <span class="annotation">@EnableWebSecurity</span>
                        <span class="keyword">public class</span> WebSecurityConfig <span class="keyword">implements </span> WebMvcConfigurer {

                        &emsp;&emsp;&emsp;&emsp;<span class="annotation">@Bean</span>
                        &emsp;&emsp;&emsp;&emsp;<span class="keyword">public </span> UserDetailsService userDetailsService() <span class="keyowrd">throws</span> Exception{ 
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;InMemoryUserDetailsManager manager = <span class="keyword">new </span> InMemoryUserDetailsManager();
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;manager.createUser(User.withDefaultPasswordEncoder().username(<span class="string">"user"</span>).password(<span class="string">"password"</span>).roles(<span class="string">"USER"</span>).build());
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span class="keyword">return </span> manager;
                        &emsp;&emsp;&emsp;&emsp;}
                        }
                </code>
            </pre>

            <p>Ο παραπάνω κώδικας είναι μικρός, αλλά κάνει πολλά.</p>

            <ul>
                <li>Απαιτεί <span class="bold">αυθεντικοποίηση σε κάθε URL</span> της εφαρμογής</li>
                <li>Δημιουργεί μια <span class="bold">φόρμα login</span></li>
                <li>Επιτρέπει στο χρήστη με το <span class="bold">όνομα</span> user και <span class="bold">κωδικό</span> password, να αυθεντικοποιηθεί μέσω της φόρμας</li>
                <li>Επιτρέπει στο χρήστη , να <span class="bold">αποσυνδεθεί</span></li>
                <li>Αποτρέπει <span class="bold">CSRF</span> επιθέσεις</li>
                <li>Προστατεύει από <span class="bold">Session Fixation</span></li>
            </ul>

            <p class="font-weight-bold mt-5">HttpSecurity</p>

            <p>Η κλάση <span class="code">WebSecurityConfigurerAdapter</span> παρέχει τη μέθοδο <span class="code">configure(HttpSecurity http)</span>. Σε αυτήν ορίζουμε πια urls της εφαρμογής πρέπει,
                να είναι ασφαλή, αν οι χρήστες πρέπει, να αυθεντικοποιηθούν, για να έχουν πρόσβαση σε αυτά κ.α.
            </p>

            <pre>
                <code>
                        <span class="annotation">@EnableWebSecurity</span>
                        <span class="keyword">public class</span> WebSecurityConfig <span class="keyword">extends </span>WebSecurityConfigurerAdapter {

                        &emsp;&emsp;&emsp;&emsp;<span class="keyword">public </span> configure(HttpSecurity http) <span class="keyowrd">throws</span> Exception{ 
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;http
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.authorizeRequests()
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.anyRequest().authenticated()
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.and()
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.formLogin()
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.and()
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.httpBasic();
                        &emsp;&emsp;&emsp;&emsp;}
                        }
                </code>
            </pre>

            <p>Το παραπάνω default configuration :</p>

            <ul>
                <li>Διασφαλίζει ότι οποιοδήποτε αίτημα στην εφαρμογή, πρέπει να προέρχεται από <span class="bold">αυθεντικοποιημένο</span> χρήστη</li>
                <li>Επιτρέπει στους χρήστες, να αυθεντικοποιούνται με μια φόρμα</li>
                <li>Ενεργοποιεί το <span class="bold">HTTP Basic</span> authentication</li>
            </ul>
            
            <p class="font-weight-bold mt-5">Login φόρμα</p>

            <p>Το default configuration δεν ορίζει ρήτα ένα URL, για τη φόρμα και δημιουργεί μια αυτόματα. Εάν θέλουμε, να παρέχουμε τη δικιά μας φόρμα,
                χρειάζεται το ακόλουθο configuration :
            </p>

            <pre>
                <code>
                        &emsp;&emsp;&emsp;&emsp;<span class="keyword">public </span> configure(HttpSecurity http) <span class="keyword">throws</span> Exception{ 
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;http
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.authorizeRequests()
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.anyRequest().authenticated()
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.and()
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.formLogin()
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.loginPage(<span class="string">"/login"</span>)
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.permitAll(); 
                        &emsp;&emsp;&emsp;&emsp;}
                </code>
            </pre>

            <p>Παραπάνω, ορίζουμε ότι η login φόρμα μας βρίσκεται στο URL <span class="bold">/login</span> και επιτρέπουμε σε όλους τους χρήστες(και σε αυτούς, που δεν έχουν
                αυθεντικοποιηθεί) την πρόσβαση.</p>


            <p class="font-weight-bold mt-5">Εξουσιοδότηση αιτημάτων</p>

            <p>Μπορούμε, να ορίσουμε σε <span class="bold">ποια URLS επιτρέπεται</span>, να έχουν <span class="bold">πρόσβαση</span> οι χρήστες και τους <span class="bold">τύπους</span> των χρηστών.</p>

            <pre>
                <code>
                        &emsp;&emsp;&emsp;&emsp;<span class="keyword">public </span> configure(HttpSecurity http) <span class="keyword">throws</span> Exception{ 
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;http 
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.antMatchers(<span class="string">"/resources/**"</span>, <span class="string">"/signup"</span>, <span class="string">"/about"</span>).permitAll()
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.antMatchers(<span class="string">"/admin/**"</span>).hasRole(<span class="string">"ADMIN"</span>)     
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.and()
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.formLogin(); 
                        &emsp;&emsp;&emsp;&emsp;}
                </code>
            </pre>

            <ul>
                <li>Επιτρέπεται η πρόσβαση σε <span class="bold">όλους τους χρήστες</span>, στα URLs που ξεκινούν με <span class="bold">"/resources/**"</span>, <span class="bold">"/signup"</span> και <span class="bold">"/about"</span>. </li>
                <li>Επιτρέπεται η πρόσβαση στους χρήστες με <span class="bold">ρόλο ADMIN</span>, στα URLs που ξεκινούν με <span class="bold">"/admin/**"</span>. </li>
                <li>Στα <span class="bold">υπόλοιπα URLs</span>, επιτρέπεται η πρόσβαση μόνο σε αυθεντικοποιημένους χρήστες.</li>
            </ul>

            <p class="font-weight-bold mt-5">Διαχείριση αποσύνδεσης</p>

            <p>Όταν χρησιμοποιούμε το <span class="code">WebSecurityConfigurerAdapter</span>, η δυνατότητα αποσύνδεσης παρέχεται αυτόματα. Το default URL για να
                αποσυνδεθεί ο χρήστης, είναι το <span class="bold">/logout</span>. Μπορούμε, να προσαρμόσουμε το configuration, ανάλογα  με τις ανάγκες μας:
            </p>

            <pre>
                <code>
                        &emsp;&emsp;&emsp;&emsp;<span class="keyword">public </span> configure(HttpSecurity http) <span class="keyword">throws</span> Exception{ 
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;http 
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.logout() 
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.logoutUrl(<span class="string">"/my/logout"</span>)     
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.logoutSuccessUrl(<span class="string">"/my/index"</span>) 
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.logoutSuccessHandler(logoutSuccessHandler)
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.invalidateHttpSession(true) 
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.deleteCookies(cookieNamesToClear) 
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.and()
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;...
                        &emsp;&emsp;&emsp;&emsp;}
                </code>
            </pre>

            <ul>
                <li>Ορίζουμε ότι ο χρήστης, μπορεί να <span class="bold">αποσυνδεθεί</span> στο URL <span class="bold">"/my/logout"</span></li>
                <li>Αφού γίνει η αποσυνδεθεί ο χρήστης, θα <span class="bold">ανακατευθυνθεί</span> στο URL <span class="bold">"/my/index"</span></li>
                <li>Ορίζουμε ένα προσαρμοσμένο LogoutSuccessHandler</li>
                <li><span class="bold">Ακυρώνεται</span> το <span class="bold">HTTP session</span></li>
                <li>Ορίζουμε ποια <span class="bold">cookies</span>, θέλουμε να <span class="bold">διαγραφούν</span></li>
            </ul>

        </section>

        <section class="authentication">

            <h5>Αυθεντικοποίηση</h5>

            <p class="font-weight-bold">In-Memory Αυθεντικοποίηση</p>

            <p>Μπορούμε να επιλέξουμε, οι χρήστες να <span class="bold">αποθηκεύονται στην μνήμη</span></p>

            <pre>
                <code>
                        <span class="annotation">@EnableWebSecurity</span>
                        <span class="keyword">public class</span> WebSecurityConfig <span class="keyword">extends </span> WebSecurityConfigurerAdapter  {

                        &emsp;&emsp;&emsp;&emsp;<span class="annotation">@Override</span>
                        &emsp;&emsp;&emsp;&emsp;<span class="keyword">protected void</span> configure(AuthenticationManagerBuilder auth) <span class="keyword">throws</span> Exception{ 

                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;auth
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.inMemoryAuthentication()
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.withUser(<span class="string">"user"</span>).password(<span class="string">"password")</span>.roles(<span class="string">"USER"</span>).and()
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.withUser(<span class="string">"admin"</span>).password(<span class="string">"password"</span>).roles(<span class="string">"USER"</span>, <span class="string">"ADMIN"</span>);
                        &emsp;&emsp;&emsp;&emsp;}
                        }
                </code>
            </pre>

            <p>Δημιουργούμε <span class="bold"></span>δύο χρήστες : τον χρήστη <span class="bold">user</span> με κωδικό <span class="bold">password</span> και ρόλο <span class="bold">USER</span> 
                και τον χρήστη <span class="bold">user</span> με κωδικό <span class="bold">password</span> και ρόλους <span class="bold">USER</span>, <span class="bold">ADMIN</span>.</p>

            <p class="font-weight-bold">JDBC Αυθεντικοποίηση</p>

            <p>Μπορούμε να αποθηκεύσουμε τους χρήστες <span class="bold">στη βάση δεδομένων</span>, αρκεί να έχουμε ορίσει ένα <span class="code">Datasource</span> στην εφαρμογή.</p>

            <pre>
                <code>
                        <span class="annotation">@EnableWebSecurity</span>
                        <span class="keyword">public class</span> WebSecurityConfig <span class="keyword">extends </span> WebSecurityConfigurerAdapter  {

                        &emsp;&emsp;&emsp;&emsp;<span class="annotation">@Autowired</span>
                        &emsp;&emsp;&emsp;&emsp;<span class="keyword">private</span> DataSource dataSource;

                        &emsp;&emsp;&emsp;&emsp;<span class="annotation">@Autowired</span>
                        &emsp;&emsp;&emsp;&emsp;<span class="keyword">protected void</span> configure(AuthenticationManagerBuilder auth) <span class="keyword">throws</span> Exception{ 

                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;auth
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.jdbcAuthentication()
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.passwordEncoder(passwordEncoder())
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.usersByUsernameQuery(<span class="string">"select username, password, is_active from users where username=?"</span>)
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;.authoritiesByUsernameQuery(<span class="string">"select username, role from authorities where username=?"</span>);
                        &emsp;&emsp;&emsp;&emsp;}

                        &emsp;&emsp;&emsp;&emsp;<span class="annotation">@Bean(name = <span class="string">"passwordEncoder"</span>)</span>
                        &emsp;&emsp;&emsp;&emsp;<span class="keyword">public</span> BCryptPasswordEncoder passwordEncoder() { 
                        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span class="keyoword">return new</span> BCryptPasswordEncoder();
                        &emsp;&emsp;&emsp;&emsp;}
                        }
                </code>
            </pre>

            <ul>
                <li>Ενεργοποιούμε την <span class="bold">JDBC αυθεντικοποίηση</span></li>
                <li>Χρησιμοποιούμε το <span class="bold">BCryptPasswordEncoder</span>, για την <span class="bold">κρυπτογράφηση των κωδικών</span></li>
                <li>Ορίζουμε τα <span class="bold">SQL ερωτήματα</span>, τα οποία επιστρέφουν τα <span class="bold">ονόματα</span> των χρηστών και το <span class="bold">authority</span> τους</li>
            </ul>

        </section>

        <section class="references">

            <h5>Πηγές</h5>

            <ul>
                <li><a href="https://en.wikipedia.org/wiki/Spring_Security">Wikipedia : Spring Security</a></li>
                <li><a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#hello-web-security-java-configuration">Spring Security Reference - 6.1 Hello Web Security Java Configuration</a></li>
                <li><a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#jc-httpsecurity">Spring Security Reference - 6.2 HttpSecurity</a></li>
                <li><a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#jc-form">Spring Security Reference - 6.3 Java Configuration and Form Login</a></li>
                <li><a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#jc-authorize-requests">Spring Security Reference - 6.4 Authorize Requests</a></li>
                <li><a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#jc-logout">Spring Security Reference - 6.5 Handling Logouts</a></li>
            </ul>
        </section>
    </div>

  </body>
</html>
