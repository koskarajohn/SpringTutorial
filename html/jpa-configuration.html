<!DOCTYPE html>
<html>
  <head>
    <title>Ρύθμιση βάσης δεδομένων και JPA</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/index.css">
    
    <script src="../js/jquery.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
  </head>

  <body>

     <nav class="navbar navbar-expand-md fixed-top" id="mainNav">

        <div class="container">
            <a class="navbar-brand" href="../index.html">SpringTutorial</a>

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false">
                <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav ml-5">
                <li class="nav-item dropdown">
                          <a class="nav-link dropdown-toggle" href="#" id="navbarSpring" data-toggle="dropdown">Spring</a>
                          <div class="dropdown-menu">
                              <a class="dropdown-item" href="spring.html">What is Spring</a>
                              <a class="dropdown-item" href="spring-container.html">Spring IoC Container</a>
                              <a class="dropdown-item" href="spring-beans.html">Spring Beans</a>
                              <a class="dropdown-item" href="dependency-injection.html">Dependency Injection</a>
                              <a class="dropdown-item" href="annotations.html">Annotations</a>
                              <a class="dropdown-item" href="spring-boot.html">Spring Boot</a>
                              <a class="dropdown-item" href="spring-mvc.html">Spring Mvc</a>
                              <a class="dropdown-item" href="spring-security.html">Spring Security</a>
                              <a class="dropdown-item" href="html/rest-api.html">Rest API</a>
                            </div>
                      </li>
                      <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarJpa" data-toggle="dropdown">JPA</a>
                            <div class="dropdown-menu">
                              <a class="dropdown-item" href="jpa.html">JPA</a>
                              <a class="dropdown-item" href="spring-data-jpa.html">Spring Data Jpa</a>
                            </div>
                      </li>
                      <li class="nav-item dropdown">
                          <a class="nav-link dropdown-toggle" href="#" id="navbarSetup" data-toggle="dropdown">Setup εφαρμογης</a>
                          <div class="dropdown-menu">
                              <a class="dropdown-item" href="spring-tool-suite.html">Spring Tool Suite</a>
                              <a class="dropdown-item" href="heroku.html">Heroku</a>
                              <a class="dropdown-item" href="postgresql.html">Postgres</a>
                              <a class="dropdown-item" href="jpa-configuration.html">Ρύθμιση βάσης δεδομένων και JPA</a>
                            </div>
                      </li>
                      <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarCreateApp" data-toggle="dropdown">Δημιουργία εφαρμογης</a>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" href="app-architecture.html">Αρχιτεκτονική εφαρμογής</a>
                            <a class="dropdown-item" href="angular.html">Angular</a>
                          </div>
                      </li>
            </ul>
        </div>
      </div>
   
    </nav>

    <div class="container">

        <h1 class="text-center">Ρύθμιση βάσης δεδομένων και JPA</h1>

        <section class="intro ">

            <h5>PostgreSQL</h5>

            <p>Το Heroku παρέχει τη βάση δεδομένων PostgreSQL. Δημιουργήσαμε μια βάση δεδομένων στο Heroku <a href="postgresql.html">εδώ</a>. Θα δημιουργήσουμε τους πίνακες
                στη τοπική βάση δεδομένων. Μετά, μπορούμε να κάνουμε export τη βάση και να την κανουμε import στον απομακρυσμένο server στο Heroku.
            </p>

            <p>Για να μπορέσουμε, να χρησιμοποιήσουμε τις βάσεις, χρειάζεται να προσθέσουμε κάποια dependencies στο pom.xml, να προσθέσουμε κάποια properties
                στο αρχείο application.properties και να δημιουργήσουμε μια κλάση configuration, για να ρυθμίσουμε το JPA.
            </p>

            <h5 class="mt-4">Dependencies</h5>

            <p>
                Προσθέτουμε στο αρχείο pom.xml, τα ακόλουθα dependencies.
                <pre>
                    <code>
                        <span class="annotation">&#60;dependency&#62;</span>
                        <span class="annotation">&emsp;&emsp;&#60;groupId&#62;</span> org.springframework.boot <span class="annotation">&#60;/groupId&#62;</span>
                        <span class="annotation">&emsp;&emsp;&#60;artifactId&#60;</span> spring-boot-starter-data-jpa <span class="annotation">&#60;/artifactId&#62;</span>
                        <span class="annotation">&#60;/dependency&#62;</span>

                        <span class="annotation">&#60;dependency&#62;</span>
                        <span class="annotation">&emsp;&emsp;&#60;groupId&#62;</span> org.postgresql <span class="annotation">&#60;/groupId&#62;</span>
                        <span class="annotation">&emsp;&emsp;&#60;artifactId&#62;</span> postgresql <span class="annotation">&#60;/artifactId&#62;</span>
                        <span class="annotation">&#60;/dependency&#62;</span>
                    </code>
                </pre>
            </p>
        </section>

        <section class="application-properties">

            <h5>Application Properties</h5>

            <p>Προσθέτουμε τα ακόλουθα properties στο αρχείο application.properties. Τα πρώτα 8 περιέχουν ρυθμίσεις για την τοπική και 
                απομακρυσμένη βάση δεδομένων, όπως URL, username και password. Όταν θέλουμε, να τρέξουμε την εφαρμογή τοπικά, πρέπει να κάνουμε comment out
                τα properties για το Heroku. Αντίστοιχα όταν θέλουμε, να κάνουμε push τις αλλαγές μας στο Heroku, πρέπει να κάνουμε comment out τα properties για το local.
               Επίσης, παρέχουμε κάποια properties που χρειάζεται το Hibernate και το HikariCP.</p>

            <pre>
                <code>
                        &emsp;&emsp;&emsp;&emsp;#local
                        &emsp;&emsp;&emsp;&emsp;spring.datasource.driver-class-name = org.postgresql.Driver
                        &emsp;&emsp;&emsp;&emsp;spring.datasource.url = jdbc:postgresql://localhost:5432/postgres
                        &emsp;&emsp;&emsp;&emsp;spring.datasource.username = postgres
                        &emsp;&emsp;&emsp;&emsp;spring.datasource.password = root 

                        &emsp;&emsp;&emsp;&emsp;#Heroku
                        &emsp;&emsp;&emsp;&emsp;spring.datasource.driver-class-name = org.postgresql.Driver
                        &emsp;&emsp;&emsp;&emsp;spring.datasource.url = ${JDBC_DATABASE_URL}
                        &emsp;&emsp;&emsp;&emsp;spring.datasource.username = ${JDBC_DATABASE_USERNAME}
                        &emsp;&emsp;&emsp;&emsp;spring.datasource.password = ${JDBC_DATABASE_PASSWORD}

                        &emsp;&emsp;&emsp;&emsp;spring.jpa.properties.hibernate.hbm2ddl.method = update
                        &emsp;&emsp;&emsp;&emsp;spring.jpa.properties.hibernate.dialect = org.hibernate.dialect.PostgreSQLDialect
                        &emsp;&emsp;&emsp;&emsp;spring.jpa.properties.hibernate.show_sql = true
                        &emsp;&emsp;&emsp;&emsp;spring.jpa.properties.hibernate.format_sql = true
                        &emsp;&emsp;&emsp;&emsp;spring.jpa.properties.hibernate.jdbc.lob.non_contextual_creation=true

                        &emsp;&emsp;&emsp;&emsp;spring.datasource.hikari.minimumIdle=2
                        &emsp;&emsp;&emsp;&emsp;spring.datasource.hikari.maximumPoolSize=10
                        &emsp;&emsp;&emsp;&emsp;spring.datasource.hikari.idleTimeout=300000
                        &emsp;&emsp;&emsp;&emsp;spring.datasource.hikari.maxLifetime=1200000
                        &emsp;&emsp;&emsp;&emsp;spring.datasource.hikari.connectionTimeout=20000
                </code>
            </pre>
        </section>
        <section class="configuration">
            <h5 class="mt-4">JPA Configuration</h5>

            <p>
                Θα δημιουργήσουμε μια κλάση JpaConfiguration.java, η οποία θα περιέχει διάφορες ρυθμίσεις για το JPA. Χρησιμοποιούμε τα
                annotations @Configuration, @EnableJpaRepositories και @EnableTransactionManagement.
                <pre>
                    <code>
                        <span class="annotation">@Configuration</span>
                        <span class="annotation">@EnableJpaRepositories</span>(basePackages = <span class="string">"springeshop.repositories"</span>,
                                               entityManagerFactoryRef = <span class="string">"entityManagerFactory"</span>,
                                               transactionManagerRef = <span class="string">"transactionManager"</span>)
                        <span class="annotation">@EnableTransactionManagement</span>
                        <span class="keyword"> public class</span> <span class="classname"> JpaConfiguration</span> {
                    </code>
                </pre>
                @Configuration : Η κλάση περιέχει bean definitions, δηλαδή beans με το annotation @Bean<br>
                @EnableJpaRepositories : Είναι annotation, για να ενεργοποιηθούν τα JpaRepositories.
                @EnableTransactionManagement : Είναι annotation, για να ενεργοποιηθεί το transaction management.
            </p>

            <h5 class="mt-4">Datasource Bean</h5>

            <p>
                Το Datasource Bean είναι ένα εργοστάσιο για τη δημιουργία συνδέσεων με το φυσικό datasource, το οποίο αυτό
                Datasource αντικειμένο αναπαριστά, δηλαδή την βάση δεδομένων PostgreSQL. Χρειάζεται, να δώσουμε τιμές σε παραμέτρους, 
                όπως το url της βάσης, το username, password και το Jdbc Driver.
                <pre>
                    <code>
                        DriverManagerDataSource dataSource = <span class="keyword">new</span> DriverManagerDataSource();
		                dataSource.setDriverClassName(<span class="string">"org.postgresql.Driver"</span>);
		                dataSource.setUrl(<span class="string">"jdbc:postgresql://localhost:5432/postgres"</span>);
		                dataSource.setUsername(<span class="string">"root"</span>);
	                    dataSource.setPassword(<span class="string">"root"</span>);	
		                <span class="keyword">return</span> dataSource;
                    </code>
                </pre>
                
            </p>

            <h5 class="mt-4">Transaction Manager Bean</h5>

            <p>
                Πρέπει να δημιουργήσουμε ένα transaction manager bean, το οποίο ενσωματώνει τον JPA provider, με το transaction management
                του Spring. Θα χρησιμοποιήσουμε την κλάση JpaTransactionManager, ως τον transaction manager της εφαρμογής.
                <pre>
                    <code>
                        <span class="annotation">@Bean</span>
                        <span class="annotation">@Autowired</span>
	                    <span class="keyword">public</span> PlatformTransactionManager transactionManager(EntityManagerFactory emf){
		                JpaTransactionManager txManager = <span class="keyword">new</span> JpaTransactionManager();
		                txManager.setEntityManagerFactory(emf);
		                <span class="keyword">return</span> txManager;
	                    }
                    </code>
                </pre>
                
            </p>

            <h5 class="mt-4">JpaVendorAdapter Bean</h5>

            <p>
                Δηλώνουμε ότι θα χρησιμοποιήσουμε το Hibernate ως persistence provider
                <pre>
                    <code>
                        <span class="annotation">@Bean</span>
	                    <span class="keyword">public</span> JpaVendorAdapter jpaVendorAdapter(){
		                HibernateJpaVendorAdapter hibernateJpaVendorAdapter = <span class="keyword">new</span> HibernateJpaVendorAdapter();
		                <span class="keyword">return</span> hibernateJpaVendorAdapter;
	                    }
                    </code>
                </pre>
                
            </p>

            <h5 class="mt-4">JpaProperties</h5>

            <p>
                Δηλώνουμε κάποια συγκεκριμένα properties για το Hibernate.
                <pre>
                    <code>
                        <span class="keyword">private</span> Properties jpaProperties(){
                        Properties properties = <span class="keyword">new</span> Properties();	
                        properties.put(<span class="string">"hibernate.hbm2ddl.method"</span>, environment.getRequiredProperty(<span class="string">"spring.jpa.properties.hibernate.hbm2ddl.method"</span>));
                        properties.put(<span class="string">"hibernate.show_sql"</span>, environment.getRequiredProperty(<span class="string">"spring.jpa.properties.hibernate.show_sql"</span>));
                        properties.put(<span class="string">"hibernate.format_sql"</span>, environment.getRequiredProperty(<span class="string">"spring.jpa.properties.hibernate.format_sql"</span>));
                        properties.put(<span class="string">"hibernate.dialect"</span>, environment.getRequiredProperty(<span class="string">"spring.jpa.properties.hibernate.dialect"</span>));
                        properties.put(<span class="string">"hibernate.jdbc.lob.non_contextual_creation"</span>, environment.getRequiredProperty(<span class="string">"spring.jpa.properties.hibernate.jdbc.lob.non_contextual_creation"</span>));
                        <span class="keyword">return</span> properties;
                        }
                    </code>
                </pre>
                
            </p>

            <h5 class="mt-4">EntityManager Bean</h5>

            <p>
                Για να χρησιμοποιήσουμε το JPA, πρέπει να δημιουργήσουμε τον EntityManager. Ο EntityManager παρέχει λειτουργίες πάνω στη βάση,
                όπως η εύρεση και η αποθήκευση αντικειμένων.
                <pre>
                    <code>
                        LocalContainerEntityManagerFactoryBean factoryBean = <span class="keyword">new</span> LocalContainerEntityManagerFactoryBean();
                        factoryBean.setDataSource(dataSource());
                        factoryBean.setPackagesToScan(<span class="keyword">new</span> String[] { <span class="string">"springeshop.model"</span> });
                        factoryBean.setJpaVendorAdapter(jpaVendorAdapter());
                        factoryBean.setJpaProperties(jpaProperties());
                        <span class="keyword">return</span> factoryBean;
                    </code>
                </pre>
                
            </p>

        </section>
    </div>

  </body>
</html>
