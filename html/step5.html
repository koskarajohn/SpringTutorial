<!DOCTYPE html>
<html>
  <head>
    <title>Βήμα 5</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:100,200,300,400,500,600,700,800,900" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i" rel="stylesheet">
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/index.css">
    
    <script src="../js/jquery.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
  </head>

  <body>

    <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-primary" id="sideNav">

        <a class="navbar-brand" href="../index.html">
            <span>Learn Spring</span>
        </a>

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false">
                <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="spring.html">Spring</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="spring-container.html">Spring IoC Container</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="dependency-injection.html">Dependency Injection</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="step2.html">Βημα 2</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="step3.html">Βημα 3</a>
                </li>    
                <li class="nav-item">
                    <a class="nav-link" href="step4.html">Βημα 4</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="step5.html">Βημα 5</a>
                </li> 
                <li class="nav-item">
                    <a class="nav-link" href="step5.html">Βημα 6</a>
                </li>  

            </ul>
        </div>
    </nav>

    <div class="container-fluid content">
        <div>
            <h1 class="text-center">Βημα 5 : JPA Configuration</h1>
        </div>

        <section class="intro px-5 mt-5">

            <h5 class="mt-4">PostgreSQL</h5>

            <p>
                Η εφαρμογή μας θα χρειαστεί μια βάση δεδομένων, για να αποθηκεύσουμε δεδομένα όπως προιόντα. Το Heroku παρέχει
                τη βάση δεδομένων PostgreSQL, οπότε θα χρησιμοποιήσουμε αυτή.
            </p>

            <h5 class="mt-4">ORM</h5>

            <p>
                Υπάρχει ασυμβατότητα μεταξύ του μοντέλου αντικειμένου και της  σχεσιακής βάσης δεδομένων.
                 Η βάση δεδομένων αναπαριστά τα δεδομένα σε μορφή πίνακα, ενώ οι αντικειμενοστραφείς γλώσσες όπως η Java και η C#, 
                 τα αναπαριστούν ως έναν διασυνδεδεμένο γράφο αντικειμένων.
            </p>

            <h5 class="mt-4">JPA</h5>

            <p>
                Το Java Persistence API(JPA) είναι ένα Java specification για την πρόσβαση, αποθήκευση και διαχείριση δεδομένων μεταξύ των
                κλάσεων της Java και της βάσης δεδομένων. Θεωρείται η standard προσέγγιση για Object To Relational Mapping(ORM) στη βιομηχανία
                της Java.
            </p>

            <p>
                Είναι ένα specification, όχι προιόν. Είναι ένα σύνολο από interfaces και απαιτεί εφαρμογή. To JPA επιτρέπει 
                στα Plain Old Java Objects(POJOs), να αποθηκεύονται εύκολα στη βάση, χωρίς να χρειάζεται αυτές οι κλάσεις,
                να εφαρμόσουν κάποιο interface ή μέθοδο.
            </p>

            <h5 class="mt-4">Hibernate</h5>

            <p>
                Είναι ένα object-relational mapping (ORM) framework για τη Java και εφαρμογή του JPA specification. Αντιστοιχίζει κλάσεις της Java σε πίνακες βάσης δεδομένων
                και τύπους δεδομένων Java σε τύπους SQL

            </p>

            <h5 class="mt-4">Spring Data JPA</h5>

            <p>
                Το Spring Data JPA δεν είναι ένας πάροχος JPA. Είναι ένα framework, το οποίο παρέχει ένα επιπλέον επίπεδο αφαίρεσης, πάνω από
                τον JPA provider. Παρέχει υποστήριξη, για τη δημιουργία JPA repositories, κάνοντας extend τα repository interfaces του Spring Data.
            </p>

            <h5 class="mt-4">Dependencies</h5>

            <p>
                Για να χρησιμοποιήσουμε το JPA, χρείαζεται να προσθέσουμε στο αρχείο pom.xml, τα ακόλουθα dependencies
                <pre>
                    <code>
                        <dependency>
                            <groupId>org.springframework.boot</groupId>
                            <artifactId>spring-boot-starter-data-jpa</artifactId>
                        </dependency>

                        <dependency>
                            <groupId>org.postgresql</groupId>
                            <artifactId>postgresql</artifactId>
                            <scope>runtime</scope>
                        </dependency>
                    </code>
                </pre>
                Ο προεπιλεγμένος persistence provider είναι το Hibernate. Επειδή το Spring Data JPA βρίσκεται στο classpath, το Spring Data JPA
                αυτόματα θα παράξει τα repository implementations, από τα repository interfaces.
            </p>
        </section>

        <section class="configuration px-5 mt-5">
            <h5 class="mt-4">JPA Configuration</h5>

            <p>
                Θα δημιουργήσουμε μια κλάση JpaConfiguration.java, η οποία θα περιέχει διάφορες ρυθμίσεις για το JPA. Χρησιμοποιούμε τα
                annotations @Configuration, @EnableJpaRepositories και @EnableTransactionManagement.
                <pre>
                    <code>
                        <span class="annotation">@Configuration</span>
                        <span class="annotation">@EnableJpaRepositories</span>(basePackages = <span class="string">"springeshop.repositories"</span>,
                                               entityManagerFactoryRef = <span class="string">"entityManagerFactory"</span>,
                                               transactionManagerRef = <span class="string">"transactionManager"</span>)
                        <span class="annotation">@EnableTransactionManagement</span>
                        <span class="keyword"> public class</span> <span class="classname"> JpaConfiguration</span> {
                    </code>
                </pre>
                @Configuration : Η κλάση περιέχει bean definitions, δηλαδή beans με το annotation @Bean<br>
                @EnableJpaRepositories : Είναι annotation, για να ενεργοποιηθούν τα JpaRepositories.
                @EnableTransactionManagement : Είναι annotation, για να ενεργοποιηθεί το transaction management.
            </p>

            <h5 class="mt-4">Datasource Bean</h5>

            <p>
                Το Datasource Bean είναι ένα εργοστάσιο για τη δημιουργία συνδέσεων με το φυσικό datasource, το οποίο αυτό
                Datasource αντικειμένο αναπαριστά, δηλαδή την βάση δεδομένων PostgreSQL. Χρειάζεται, να δώσουμε τιμές σε παραμέτρους, 
                όπως το url της βάσης, το username, password και το Jdbc Driver.
                <pre>
                    <code>
                        DriverManagerDataSource dataSource = <span class="keyword">new</span> DriverManagerDataSource();
		                dataSource.setDriverClassName(<span class="string">"org.postgresql.Driver"</span>);
		                dataSource.setUrl(<span class="string">"jdbc:postgresql://localhost:5432/postgres"</span>);
		                dataSource.setUsername(<span class="string">"root"</span>);
	                    dataSource.setPassword(<span class="string">"root"</span>);	
		                <span class="keyword">return</span> dataSource;
                    </code>
                </pre>
                
            </p>

            <h5 class="mt-4">Transaction Manager Bean</h5>

            <p>
                Πρέπει να δημιουργήσουμε ένα transaction manager bean, το οποίο ενσωματώνει τον JPA provider, με το transaction management
                του Spring. Θα χρησιμοποιήσουμε την κλάση JpaTransactionManager, ως τον transaction manager της εφαρμογής.
                <pre>
                    <code>
                        <span class="annotation">@Bean</span>
                        <span class="annotation">@Autowired</span>
	                    <span class="keyword">public</span> PlatformTransactionManager transactionManager(EntityManagerFactory emf){
		                JpaTransactionManager txManager = <span class="keyword">new</span> JpaTransactionManager();
		                txManager.setEntityManagerFactory(emf);
		                <span class="keyword">return</span> txManager;
	                    }
                    </code>
                </pre>
                
            </p>

            <h5 class="mt-4">JpaVendorAdapter Bean</h5>

            <p>
                Δηλώνουμε ότι θα χρησιμοποιήσουμε το Hibernate ως persistence provider
                <pre>
                    <code>
                        <span class="annotation">@Bean</span>
	                    <span class="keyword">public</span> JpaVendorAdapter jpaVendorAdapter(){
		                HibernateJpaVendorAdapter hibernateJpaVendorAdapter = <span class="keyword">new</span> HibernateJpaVendorAdapter();
		                <span class="keyword">return</span> hibernateJpaVendorAdapter;
	                    }
                    </code>
                </pre>
                
            </p>

            <h5 class="mt-4">JpaProperties</h5>

            <p>
                Δηλώνουμε κάποια συγκεκριμένα properties για το Hibernate.
                <pre>
                    <code>
                        <span class="keyword">private</span> Properties jpaProperties(){
                        Properties properties = <span class="keyword">new</span> Properties();	
                        properties.put(<span class="string">"hibernate.hbm2ddl.method"</span>, environment.getRequiredProperty(<span class="string">"spring.jpa.properties.hibernate.hbm2ddl.method"</span>));
                        properties.put(<span class="string">"hibernate.show_sql"</span>, environment.getRequiredProperty(<span class="string">"spring.jpa.properties.hibernate.show_sql"</span>));
                        properties.put(<span class="string">"hibernate.format_sql"</span>, environment.getRequiredProperty(<span class="string">"spring.jpa.properties.hibernate.format_sql"</span>));
                        properties.put(<span class="string">"hibernate.dialect"</span>, environment.getRequiredProperty(<span class="string">"spring.jpa.properties.hibernate.dialect"</span>));
                        properties.put(<span class="string">"hibernate.jdbc.lob.non_contextual_creation"</span>, environment.getRequiredProperty(<span class="string">"spring.jpa.properties.hibernate.jdbc.lob.non_contextual_creation"</span>));
                        <span class="keyword">return</span> properties;
                        }
                    </code>
                </pre>
                
            </p>

            <h5 class="mt-4">EntityManager Bean</h5>

            <p>
                Για να χρησιμοποιήσουμε το JPA, πρέπει να δημιουργήσουμε τον EntityManager. Ο EntityManager παρέχει λειτουργίες πάνω στη βάση,
                όπως η εύρεση και η αποθήκευση αντικειμένων.
                <pre>
                    <code>
                        LocalContainerEntityManagerFactoryBean factoryBean = <span class="keyword">new</span> LocalContainerEntityManagerFactoryBean();
                        factoryBean.setDataSource(dataSource());
                        factoryBean.setPackagesToScan(<span class="keyword">new</span> String[] { <span class="string">"springeshop.model"</span> });
                        factoryBean.setJpaVendorAdapter(jpaVendorAdapter());
                        factoryBean.setJpaProperties(jpaProperties());
                        <span class="keyword">return</span> factoryBean;
                    </code>
                </pre>
                
            </p>

        </section>
    </div>

  </body>
</html>
